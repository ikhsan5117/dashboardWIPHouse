@{
    ViewData["Title"] = "RVI Items Management";
}

@section Scripts {
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    
    <!-- DataTables Buttons -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap4.min.css">
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

    <style>
        /* Inline editing styles (Matched with Items/Index.cshtml) */
        .editable-cell {
            cursor: pointer;
            position: relative;
            padding: 8px !important;
        }
        
        .editable-cell:hover {
            background-color: #f8f9fa !important;
        }
        
        .editable-cell.editing {
            padding: 2px !important;
            background-color: #fff3cd !important;
        }
        
        .inline-input {
            width: 100%;
            border: 2px solid #007bff;
            border-radius: 4px;
            padding: 6px;
            font-size: 12px;
            text-align: center;
        }
        
        .inline-input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        
        .save-cancel-buttons {
            margin-top: 5px;
            text-align: center;
        }
        
        .save-cancel-buttons button {
            margin: 0 2px;
            font-size: 10px;
            padding: 2px 8px;
        }
        
        .row-editing {
            background-color: rgba(255, 243, 205, 0.3) !important;
        }
        
        .edit-mode-indicator {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
            animation: pulse 2s infinite;
            z-index: 9999;
            position: relative;
        }
        
        @@keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .page-header {
            margin-left: 15px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .rvi-header h1 {
            color: #333 !important;
            text-shadow: none !important;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            min-width: 80px;
        }

        .status-shortage { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
        .status-normal { background-color: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; }
        .status-overstock { background-color: #d9edf7; color: #31708f; border: 1px solid #bce8f1; }

        .stock-value { font-weight: 700; }
        
        /* Table enhancements from standard items page */
        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: 8px;
        }
    </style>

    <script>
    $(document).ready(function() {
        let table;
        let currentEditingRow = null;
        let originalRowData = null;

        function loadDashboardSummary() {
            $.ajax({
                url: "@Url.Action("GetRVIItems", "RVI")",
                type: 'GET',
                success: function(response) {
                    const data = response.data;
                    $('#totalItems').text(data.length);
                    $('#expiredItems').text(data.filter(x => x.isExpired).length);
                    $('#nearExpiredItems').text(data.filter(x => x.isNearExpired).length);
                    $('#belowMinItems').text(data.filter(x => x.isBelowMin).length);
                }
            });
        }

        // Initialize DataTable
        table = $('#rviItemsTable').DataTable({
            "ajax": {
                "url": "@Url.Action("GetRVIItems", "RVI")",
                "type": "GET",
                "dataSrc": "data"
            },
            "columns": [
                {
                    "data": null,
                    "className": "text-center",
                    "title": "NO",
                    "render": function(data, type, row, meta) { return meta.row + 1; }
                },
                { "data": "itemCode", "className": "text-center", "title": "Item Code" },
                { "data": "mesin", "className": "text-center", "title": "Mesin" },
                { 
                    "data": "qtyPerBox",
                    "className": "text-center editable-cell",
                    "title": "Qty Per Box",
                    "render": function(data) { return '<span class="cell-content">' + data + '</span>'; }
                },
                { 
                    "data": "standardExp", 
                    "className": "text-center editable-cell",
                    "title": "Std Exp",
                    "render": function(data, type, row) { 
                        let value = data || 0;
                        let statusText = '';
                        if (row.isExpired) statusText = ' <span class="label label-danger">Expired</span>';
                        else if (row.isNearExpired) statusText = ' <span class="label label-warning">Near Exp</span>';
                        return '<span class="cell-content">' + value + '</span>' + statusText;
                    }
                },
                { 
                    "data": "standardMin", 
                    "className": "text-center editable-cell",
                    "title": "Std Min",
                    "render": function(data) { return '<span class="cell-content">' + data + '</span>'; }
                },
                { 
                    "data": "standardMax", 
                    "className": "text-center editable-cell",
                    "title": "Std Max",
                    "render": function(data) { return '<span class="cell-content">' + data + '</span>'; }
                },
                {
                    "data": null,
                    "className": "text-center",
                    "title": "Actions",
                    "orderable": false,
                    "render": function(data, type, row) {
                        return '<button class="btn btn-xs btn-danger delete-btn" data-item="' + row.itemCode + '"><i class="fa fa-trash"></i> Delete</button>';
                    }
                }
            ],
            "pageLength": 25,
            "dom": 'Bfrtip',
            "buttons": [
                { extend: 'excel', text: '<i class="fa fa-file-excel-o"></i> Excel', className: 'btn btn-success btn-sm' },
                { extend: 'csv', text: '<i class="fa fa-file-text-o"></i> CSV', className: 'btn btn-info btn-sm' },
                { extend: 'pdf', text: '<i class="fa fa-file-pdf-o"></i> PDF', className: 'btn btn-danger btn-sm' },
                { extend: 'print', text: '<i class="fa fa-print"></i> Print', className: 'btn btn-warning btn-sm' },
                { extend: 'colvis', text: '<i class="fa fa-columns"></i> Columns', className: 'btn btn-default btn-sm' }
            ],
            "drawCallback": function() {
                loadDashboardSummary();
            }
        });

        $('#btnRefresh').click(function() {
            table.ajax.reload();
        });

        // Add New Button
        $('#btnAddNew').click(function() { showAddDialog(); });

        function showAddDialog() {
            const dialogHtml = `
                <div id="customAddDialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin-top: 0; margin-bottom: 20px; color: #FF9800;">Add New RVI Item</h3>
                        <div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Item Code *:</label><input type="text" id="dialogItemCode" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                        <div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Qty Per Box:</label><input type="number" id="dialogQtyPerBox" value="0" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                        <div style="margin-bottom: 15px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Std Min:</label><input type="number" id="dialogStandardMin" value="0" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                        <div style="margin-bottom: 20px;"><label style="display: block; margin-bottom: 5px; font-weight: bold;">Std Max:</label><input type="number" id="dialogStandardMax" value="0" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div>
                        <div style="text-align: right;"><button id="dialogCancel" style="padding: 8px 16px; margin-right: 10px; border: 1px solid #ccc; background: #f8f8f8; cursor: pointer; border-radius: 4px;">Cancel</button><button id="dialogSave" style="padding: 8px 16px; border: none; background: #FF9800; color: white; cursor: pointer; border-radius: 4px;">Save</button></div>
                    </div>
                </div>
            `;
            $('body').append(dialogHtml);
            $('#dialogItemCode').focus();
            $('#dialogCancel').click(function() { $('#customAddDialog').remove(); });
            $('#dialogSave').click(function() {
                const data = { ItemCode: $('#dialogItemCode').val(), QtyPerBox: parseFloat($('#dialogQtyPerBox').val()) || 0, StandardMin: parseInt($('#dialogStandardMin').val()) || 0, StandardMax: parseInt($('#dialogStandardMax').val()) || 0 };
                if (!data.ItemCode) { alert('Item Code is required!'); return; }
                $.ajax({
                    url: '@Url.Action("CreateRVIItem", "RVI")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        if (response.success) { table.ajax.reload(); $('#customAddDialog').remove(); alert('Item created successfully!'); }
                        else { alert('Error: ' + response.message); }
                    }
                });
            });
        }

        // Inline editing
        $(document).on('click', '.editable-cell', function() {
            if (currentEditingRow !== null) return;
            const $cell = $(this);
            const $row = $cell.closest('tr');
            const rowData = table.row($row).data();
            const columnIndex = table.cell(this).index().column;
            const columnData = table.settings()[0].aoColumns[columnIndex].data;
            originalRowData = {...rowData};
            currentEditingRow = $row;
            $('body').prepend('<div class="edit-mode-indicator">EDIT MODE - RVI Items - Click outside or use Save/Cancel buttons to finish editing</div>');
            $row.addClass('row-editing');
            let currentValue = rowData[columnData] || 0;
            let inputHtml = `<input type="number" class="inline-input" value="${currentValue}" data-column="${columnData}" step="0.01" min="0">`;
            inputHtml += `<div class="save-cancel-buttons"><button class="btn btn-xs btn-success save-inline-btn">Save</button><button class="btn btn-xs btn-secondary cancel-inline-btn">Cancel</button></div>`;
            $cell.addClass('editing').html(inputHtml);
            $cell.find('.inline-input').focus().select();
        });

        $(document).on('click', '.save-inline-btn', function(e) {
            e.stopPropagation();
            const $row = currentEditingRow;
            const rowData = table.row($row).data();
            const updatedData = {...rowData};
            $row.find('.inline-input').each(function() {
                const column = $(this).data('column');
                updatedData[column] = parseFloat($(this).val()) || 0;
            });
            $.ajax({
                url: '@Url.Action("UpdateRVIItem", "RVI")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ItemCode: updatedData.itemCode, QtyPerBox: updatedData.qtyPerBox, StandardMin: updatedData.standardMin, StandardMax: updatedData.standardMax }),
                success: function(response) {
                    if (response.success) { table.ajax.reload(null, false); resetInlineEdit(); }
                    else { alert('Error: ' + response.message); cancelInlineEdit(); }
                }
            });
        });

        $(document).on('click', '.cancel-inline-btn', function(e) { e.stopPropagation(); cancelInlineEdit(); });

        function cancelInlineEdit() {
            if (!currentEditingRow) return;
            const $row = currentEditingRow;
            $row.find('.editing').each(function() {
                const $cell = $(this);
                const columnIndex = table.cell(this).index().column;
                const columnData = table.settings()[0].aoColumns[columnIndex].data;
                $cell.removeClass('editing').html('<span class="cell-content">' + (originalRowData[columnData] || 0) + '</span>');
            });
            resetInlineEdit();
        }

        function resetInlineEdit() {
            if (currentEditingRow) { currentEditingRow.removeClass('row-editing'); }
            currentEditingRow = null;
            originalRowData = null;
            $('.edit-mode-indicator').remove();
        }

        // Delete
        $(document).on('click', '.delete-btn', function() {
            const itemCode = $(this).data('item');
            if (!confirm('Delete item ' + itemCode + '?')) return;
            $.ajax({
                url: '@Url.Action("DeleteRVIItem", "RVI")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ItemCode: itemCode }),
                success: function(response) {
                    if (response.success) { table.ajax.reload(); }
                    else { alert('Error: ' + response.message); }
                }
            });
        });
    });
    </script>
}

<!-- Page Header -->
<div class="content-header">
    <div class="row">
        <div class="col-sm-12">
            <div class="page-header rvi-header">
                <h1><i class="gi gi-table sm-6"></i> Update Data Items RVI <small>Click on any cell (except Item Code) to edit inline</small></h1>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Summary Widgets -->
<div class="row" id="dashboardSummary" style="margin-bottom: 20px;">
    <div class="col-sm-6 col-lg-3">
        <a href="javascript:void(0)" class="widget widget-hover-effect2">
            <div class="widget-extra themed-background-dark">
                <h4 class="widget-content-light"><strong>Total RVI Items</strong></h4>
            </div>
            <div class="widget-extra-full">
                <span class="h2 text-primary animation-expandOpen" id="totalItems">0</span>
            </div>
        </a>
    </div>
    <div class="col-sm-6 col-lg-3">
        <a href="javascript:void(0)" class="widget widget-hover-effect2">
            <div class="widget-extra themed-background-danger">
                <h4 class="widget-content-light"><strong>RVI Expired</strong></h4>
            </div>
            <div class="widget-extra-full">
                <span class="h2 text-danger animation-expandOpen" id="expiredItems">0</span>
            </div>
        </a>
    </div>
    <div class="col-sm-6 col-lg-3">
        <a href="javascript:void(0)" class="widget widget-hover-effect2">
            <div class="widget-extra themed-background-warning">
                <h4 class="widget-content-light"><strong>RVI Near Expired</strong></h4>
            </div>
            <div class="widget-extra-full">
                <span class="h2 text-warning animation-expandOpen" id="nearExpiredItems">0</span>
            </div>
        </a>
    </div>
    <div class="col-sm-6 col-lg-3">
        <a href="javascript:void(0)" class="widget widget-hover-effect2">
            <div class="widget-extra themed-background-info">
                <h4 class="widget-content-light"><strong>RVI Below Min</strong></h4>
            </div>
            <div class="widget-extra-full">
                <span class="h2 text-info animation-expandOpen" id="belowMinItems">0</span>
            </div>
        </a>
    </div>
</div>

<!-- Table Content -->
<div class="row">
    <div class="col-lg-12">
        <div class="block full">
            <div class="block-title">
                <div class="block-options pull-right">
                    <button id="btnRefresh" class="btn btn-sm btn-default" title="Refresh Data"><i class="fa fa-refresh"></i></button>
                    <button id="btnAddNew" class="btn btn-sm btn-primary"><i class="fa fa-plus"></i> Add New Item</button>
                </div>
                <h2><i class="fa fa-list"></i> RVI Items List</h2>
            </div>
            <div class="table-responsive">
                <table id="rviItemsTable" class="table table-striped table-vcenter table-hover table-bordered">
                    <thead>
                        <tr>
                            <th class="text-center">NO</th>
                            <th class="text-center">Item Code</th>
                            <th class="text-center">Mesin</th>
                            <th class="text-center">Qty Per Box</th>
                            <th class="text-center">Std Exp</th>
                            <th class="text-center">Std Min</th>
                            <th class="text-center">Std Max</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
